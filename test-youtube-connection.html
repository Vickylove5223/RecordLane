<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>YouTube Connection Test</h1>
    
    <div class="test-section info">
        <h3>Test Status</h3>
        <p>This page will test your YouTube integration step by step.</p>
    </div>

    <div class="test-section">
        <h3>1. Backend Configuration Test</h3>
        <button onclick="testBackendConfig()">Test Backend Config</button>
        <div id="backend-result" class="log"></div>
    </div>

    <div class="test-section">
        <h3>2. OAuth Configuration Test</h3>
        <button onclick="testOAuthConfig()">Test OAuth Config</button>
        <div id="oauth-result" class="log"></div>
    </div>

    <div class="test-section">
        <h3>3. YouTube Connection Test</h3>
        <button onclick="testYouTubeConnection()">Test YouTube Connection</button>
        <div id="youtube-result" class="log"></div>
    </div>

    <div class="test-section">
        <h3>4. Full Integration Test</h3>
        <button onclick="runFullTest()">Run Full Test</button>
        <div id="full-test-result" class="log"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            element.textContent += logMessage;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
        }

        async function testBackendConfig() {
            clearLog('backend-result');
            log('backend-result', 'Testing backend configuration...');
            
            try {
                const response = await fetch('http://localhost:4000/auth/config');
                if (response.ok) {
                    const config = await response.json();
                    log('backend-result', `‚úÖ Backend is running!`);
                    log('backend-result', `Client ID: ${config.clientID ? 'Present' : 'Missing'}`);
                    log('backend-result', `Backend URL: http://localhost:4000`);
                } else {
                    log('backend-result', `‚ùå Backend responded with status: ${response.status}`);
                }
            } catch (error) {
                log('backend-result', `‚ùå Backend not accessible: ${error.message}`);
                log('backend-result', 'Make sure the backend is running with: encore run');
            }
        }

        async function testOAuthConfig() {
            clearLog('oauth-result');
            log('oauth-result', 'Testing OAuth configuration...');
            
            try {
                const response = await fetch('http://localhost:4000/auth/config');
                if (response.ok) {
                    const config = await response.json();
                    log('oauth-result', `‚úÖ OAuth config loaded successfully`);
                    log('oauth-result', `Client ID: ${config.clientID}`);
                    
                    // Test if we can build OAuth URL
                    const redirectUri = `${window.location.origin}/auth/callback`;
                    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${config.clientID}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/youtube.force-ssl https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile&access_type=offline&prompt=consent`;
                    
                    log('oauth-result', `‚úÖ OAuth URL generated successfully`);
                    log('oauth-result', `Redirect URI: ${redirectUri}`);
                    log('oauth-result', `Auth URL: ${authUrl.substring(0, 100)}...`);
                } else {
                    log('oauth-result', `‚ùå Failed to load OAuth config: ${response.status}`);
                }
            } catch (error) {
                log('oauth-result', `‚ùå OAuth config test failed: ${error.message}`);
            }
        }

        async function testYouTubeConnection() {
            clearLog('youtube-result');
            log('youtube-result', 'Testing YouTube connection...');
            
            try {
                // Test if we can access YouTube API
                const response = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer test-token'
                    }
                });
                
                if (response.status === 401) {
                    log('youtube-result', `‚úÖ YouTube API is accessible (401 expected without valid token)`);
                } else {
                    log('youtube-result', `‚ö†Ô∏è YouTube API responded with status: ${response.status}`);
                }
                
                log('youtube-result', `‚úÖ YouTube API endpoint is reachable`);
            } catch (error) {
                log('youtube-result', `‚ùå YouTube API test failed: ${error.message}`);
            }
        }

        async function runFullTest() {
            clearLog('full-test-result');
            log('full-test-result', 'Running full integration test...');
            
            // Test 1: Backend
            log('full-test-result', '1. Testing backend...');
            try {
                const backendResponse = await fetch('http://localhost:4000/auth/config');
                if (!backendResponse.ok) {
                    throw new Error(`Backend not accessible: ${backendResponse.status}`);
                }
                const config = await backendResponse.json();
                log('full-test-result', `‚úÖ Backend: OK (Client ID: ${config.clientID ? 'Present' : 'Missing'})`);
            } catch (error) {
                log('full-test-result', `‚ùå Backend: FAILED - ${error.message}`);
                return;
            }
            
            // Test 2: OAuth URL Generation
            log('full-test-result', '2. Testing OAuth URL generation...');
            try {
                const redirectUri = `${window.location.origin}/auth/callback`;
                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=test&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=https://www.googleapis.com/auth/youtube.upload&access_type=offline&prompt=consent`;
                log('full-test-result', `‚úÖ OAuth URL generation: OK`);
            } catch (error) {
                log('full-test-result', `‚ùå OAuth URL generation: FAILED - ${error.message}`);
            }
            
            // Test 3: YouTube API
            log('full-test-result', '3. Testing YouTube API accessibility...');
            try {
                const response = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer test' }
                });
                log('full-test-result', `‚úÖ YouTube API: OK (Status: ${response.status})`);
            } catch (error) {
                log('full-test-result', `‚ùå YouTube API: FAILED - ${error.message}`);
            }
            
            // Test 4: Frontend Integration
            log('full-test-result', '4. Testing frontend integration...');
            try {
                // Check if we can access the frontend
                const frontendResponse = await fetch(window.location.origin);
                if (frontendResponse.ok) {
                    log('full-test-result', `‚úÖ Frontend: OK`);
                } else {
                    log('full-test-result', `‚ùå Frontend: FAILED - ${frontendResponse.status}`);
                }
            } catch (error) {
                log('full-test-result', `‚ùå Frontend: FAILED - ${error.message}`);
            }
            
            log('full-test-result', '');
            log('full-test-result', 'üéâ Full integration test completed!');
            log('full-test-result', 'If all tests passed, your YouTube integration should work.');
        }

        // Auto-run backend test on page load
        window.onload = function() {
            testBackendConfig();
        };
    </script>
</body>
</html>
